<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ù„ÙˆÙƒ - ØªØ­Ø¯ÙŠ Ø§Ù„Ù…ÙˆØª âš”ï¸</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        :root { --gold: #ffcc33; --red: #ff0000; --dark: #0a0a0a; }
        
        body { background: var(--dark); color: #fff; font-family: 'Cairo', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
        .wrapper { width: 95%; max-width: 450px; text-align: center; }

        /* Ø§Ù„Ù„ÙˆØ¨ÙŠ */
        .setup-card { background: rgba(255,255,255,0.03); padding: 25px; border-radius: 30px; border: 1px solid #222; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .bet-input { width: 85%; padding: 15px; border-radius: 15px; border: 2px solid var(--gold); background: #000; color: #fff; font-size: 20px; text-align: center; margin-bottom: 25px; outline: none; }
        
        .mode-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .mode-btn { padding: 20px 10px; border-radius: 18px; border: none; cursor: pointer; transition: 0.3s; font-weight: 900; position: relative; overflow: hidden; }
        .btn-pvp { background: linear-gradient(45deg, #800000, var(--red)); color: #fff; }
        .btn-bot { background: linear-gradient(45deg, #333, #555); color: var(--gold); }
        .mode-btn:active { transform: scale(0.95); }
        .mode-btn span { display: block; font-size: 11px; font-weight: normal; opacity: 0.8; }

        /* Ø³Ø§Ø­Ø© Ø§Ù„Ù‚ØªØ§Ù„ */
        .battle-arena { height: 320px; background: url('https://i.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJndnBqZ3BqZ3BqZ3BqZ3BqZ3BqZ3BqZ3BqZ3BqZ3BqZ3BqJmVuPTEs1/3o7TKMGpxxy6T7skms/giphy.gif'); background-size: cover; position: relative; border-radius: 25px; border: 3px solid #333; margin-top: 15px; box-shadow: 0 0 20px rgba(255,0,0,0.2); }
        .hp-ui { position: absolute; top: 15px; width: 140px; height: 12px; background: #222; border-radius: 6px; border: 1px solid #444; overflow: hidden; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #ff0000, #ff6666); width: 100%; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .hp-left { left: 10px; } .hp-right { right: 10px; }
        
        .character { position: absolute; bottom: 30px; width: 90px; filter: drop-shadow(0 0 10px rgba(0,0,0,0.8)); }
        .p1-char { left: 20px; } .p2-char { right: 20px; transform: scaleX(-1); }
        .character img { width: 100%; }
        
        .projectile { position: absolute; width: 25px; height: 10px; background: #fffb00; border-radius: 50%; display: none; box-shadow: 0 0 20px gold; z-index: 10; }

        .fire-control { background: linear-gradient(180deg, #ff4444, #990000); border: none; color: white; padding: 18px 50px; border-radius: 50px; font-weight: 900; cursor: pointer; margin-top: 25px; font-size: 20px; box-shadow: 0 8px 15px rgba(255,0,0,0.3); transition: 0.2s; }
        .fire-control:disabled { background: #333; opacity: 0.5; box-shadow: none; }
        .status-bar { margin: 15px 0; color: #888; font-size: 14px; font-weight: bold; min-height: 20px; }

        .room-card { background: #111; padding: 15px; border-radius: 15px; margin-top: 10px; border: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div class="wrapper">
    <div id="lobby-screen" class="setup-card">
        <h2 style="color:var(--gold); margin-top:0;">âš”ï¸ ØªØ­Ø¯ÙŠ Ø§Ù„Ù…Ù„ÙˆÙƒ âš”ï¸</h2>
        <input type="number" id="betAmount" class="bet-input" placeholder="Ø§Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‡Ø§Ù† ğŸ’°">
        
        <div class="mode-selection">
            <button class="mode-btn btn-pvp" onclick="startCombat('player')">Ø¶Ø¯ Ù„Ø§Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ<span>Ø§Ù†ØªØ¸Ø§Ø± Ù…Ù†Ø§ÙØ³</span></button>
            <button class="mode-btn btn-bot" onclick="startCombat('bot')">Ø¶Ø¯ Ø§Ù„Ù…Ù„Ùƒ Ø§Ù„Ø¢Ù„ÙŠ<span>Ù„Ø¹Ø¨ ÙÙˆØ±ÙŠ</span></button>
        </div>

        <div id="available-rooms" style="margin-top:25px; text-align:right;">
            <p style="font-size:12px; color:#555;">ØªØ­Ø¯ÙŠØ§Øª Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†:</p>
        </div>
    </div>

    <div id="battle-screen" style="display:none">
        <div style="background:rgba(255,204,51,0.1); padding:5px; border-radius:10px; color:var(--gold); font-weight:900; margin-bottom:10px;">
            Ø±Ù‡Ø§Ù†: <span id="displayBet">0</span> | Ø¬Ø§Ø¦Ø²Ø©: <span id="displayPrize">0</span>
        </div>
        
        <div class="battle-arena" id="arena-main">
            <div class="hp-ui hp-left"><div class="hp-fill" id="hp1-bar"></div></div>
            <div class="hp-ui hp-right"><div class="hp-fill" id="hp2-bar"></div></div>
            
            <div class="projectile" id="bullet"></div>

            <div class="character p1-char"><img src="https://cdn-icons-png.flaticon.com/512/8115/8115312.png"><small id="p1-tag">Ø£Ù†Øª</small></div>
            <div class="character p2-char"><img src="https://cdn-icons-png.flaticon.com/512/1070/1070807.png"><small id="p2-tag">Ø§Ù„Ù…Ù†Ø§ÙØ³</small></div>
        </div>

        <div class="status-bar" id="game-status">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ù†Ø§ÙØ³...</div>
        <button class="fire-control" id="shoot-btn" onclick="handleUserShoot()" disabled>ğŸ”¥ Ø¥Ø·Ù€Ù„Ø§Ù‚ Ù†Ù€Ø§Ø±</button>
    </div>
</div>

<audio id="sfx-shot" src="https://www.soundjay.com/mechanical/gun-shot-1-way.mp3"></audio>
<audio id="sfx-hit" src="https://www.soundjay.com/free-music/explosion-01.mp3"></audio>

<script>
    const firebaseConfig = { databaseURL: "https://user-project-6c3bb-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const playerName = localStorage.getItem('pName') || "Ù…Ù„Ùƒ_Ù…Ø¬Ù‡ÙˆÙ„";
    let activeRoomId = null;
    let playerRole = "p1";
    let isVsBot = false;

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
    function startCombat(type) {
        const bet = parseInt(document.getElementById('betAmount').value);
        if(!bet || bet < 10) return alert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø±Ù‡Ø§Ù† 10 ğŸ’°");

        db.ref('players_logs/'+playerName+'/score').once('value').then(s => {
            const balance = s.val() || 0;
            if(balance < bet) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ!");

            // Ø®ØµÙ… Ø±Ù‡Ø§Ù† Ø§Ù„Ù„Ø¹Ø¨ (Ø­Ù‚ÙŠÙ‚ÙŠ Ø£Ùˆ Ø¨ÙˆØª)
            db.ref('players_logs/'+playerName).update({score: balance - bet});

            const roomRef = db.ref('king_combat').push();
            activeRoomId = roomRef.key;
            isVsBot = (type === 'bot');

            roomRef.set({
                p1: playerName,
                p2: isVsBot ? "Ø§Ù„Ù…Ù„Ùƒ_Ø§Ù„Ø¢Ù„ÙŠ" : null,
                bet: bet,
                hp1: 100, hp2: 100,
                turn: 'p1',
                status: isVsBot ? 'active' : 'waiting',
                mode: type
            });
            initBattleUI(bet);
        });
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ø±ÙƒØ©
    function initBattleUI(bet) {
        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('battle-screen').style.display = 'block';
        document.getElementById('displayBet').innerText = bet;
        document.getElementById('displayPrize').innerText = (bet * 2 * 0.75);

        db.ref('king_combat/'+activeRoomId).on('value', snap => {
            const room = snap.val();
            if(!room) return;

            document.getElementById('hp1-bar').style.width = room.hp1 + "%";
            document.getElementById('hp2-bar').style.width = room.hp2 + "%";
            document.getElementById('p2-tag').innerText = room.p2 || "Ø¨Ø§Ù†ØªØ¸Ø§Ø±...";

            if(room.p2) {
                const isMyTurn = (room.turn === 'p1');
                document.getElementById('shoot-btn').disabled = !isMyTurn;
                document.getElementById('game-status').innerText = isMyTurn ? "Ø¯ÙˆØ±Ùƒ.. Ø£Ø·Ù„Ù‚ Ø¨Ù‚ÙˆØ©!" : "Ø§Ù„Ø®ØµÙ… ÙŠØ¬Ù‡Ø² Ø³Ù„Ø§Ø­Ù‡...";
                
                // Ø°ÙƒØ§Ø¡ Ø§Ù„Ø¨ÙˆØª
                if(room.mode === 'bot' && room.turn === 'p2' && room.hp2 > 0) {
                    setTimeout(botLogic, 1500);
                }
            }

            if(room.lastHit && room.lastHit.by !== 'p1') {
                playShotEffect('p2', room.lastHit.success);
                db.ref('king_combat/'+activeRoomId+'/lastHit').remove();
            }

            if(room.hp1 <= 0 || room.hp2 <= 0) finalizeGame(room);
        });
    }

    // Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù†Ø§Ø± (Ø§Ù„Ù„Ø§Ø¹Ø¨)
    function handleUserShoot() {
        document.getElementById('shoot-btn').disabled = true;
        const success = Math.random() > 0.35; // Ù†Ø³Ø¨Ø© Ø¥ØµØ§Ø¨Ø© 65%
        const dmg = success ? (Math.floor(Math.random() * 15) + 15) : 0;
        
        db.ref('king_combat/'+activeRoomId).once('value').then(snap => {
            const data = snap.val();
            playShotEffect('p1', success);
            setTimeout(() => {
                db.ref('king_combat/'+activeRoomId).update({
                    hp2: Math.max(0, data.hp2 - dmg),
                    turn: 'p2',
                    lastHit: { by: 'p1', success: success }
                });
            }, 600);
        });
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨ÙˆØª (Ù„Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ)
    function botLogic() {
        const success = Math.random() > 0.45; // Ø§Ù„Ø¨ÙˆØª ÙŠØµÙŠØ¨ Ø¨Ù†Ø³Ø¨Ø© 55%
        const dmg = success ? (Math.floor(Math.random() * 12) + 13) : 0;
        
        db.ref('king_combat/'+activeRoomId).once('value').then(snap => {
            const data = snap.val();
            if(!data || data.turn !== 'p2') return;
            playShotEffect('p2', success);
            setTimeout(() => {
                db.ref('king_combat/'+activeRoomId).update({
                    hp1: Math.max(0, data.hp1 - dmg),
                    turn: 'p1',
                    lastHit: { by: 'p2', success: success }
                });
            }, 600);
        });
    }

    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© ÙˆØµÙˆØªÙŠØ©
    function playShotEffect(side, success) {
        const bullet = document.getElementById('bullet');
        document.getElementById('sfx-shot').play();
        bullet.style.display = "block";
        
        if(side === 'p1') {
            bullet.style.left = "80px";
            bullet.animate([{left:'80px'}, {left:'350px'}], 500);
        } else {
            bullet.style.left = "350px";
            bullet.animate([{left:'350px'}, {left:'80px'}], 500);
        }

        setTimeout(() => {
            bullet.style.display = "none";
            if(success) {
                document.getElementById('sfx-hit').play();
                document.getElementById('arena-main').animate([
                    {transform: 'translate(2px, 2px)'}, {transform: 'translate(-2px, -2px)'}
                ], { duration: 100, iterations: 3 });
            }
        }, 500);
    }

    // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø§Ù„
    function finalizeGame(room) {
        const winnerName = room.hp1 <= 0 ? room.p2 : room.p1;
        const totalPot = room.bet * 2;
        const prizeMoney = totalPot * 0.75;
        const adminCut = totalPot * 0.25;

        if(winnerName === playerName) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            db.ref('players_logs/'+playerName+'/score').transaction(s => (s||0) + prizeMoney);
            db.ref('admin_profits/total').transaction(s => (s||0) + adminCut);
            alert("ÙÙˆØ² Ù…Ù„ÙƒÙŠ! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ " + prizeMoney + " ğŸ’°");
        } else {
            // ÙÙŠ Ø­Ø§Ù„ ÙØ§Ø² Ø§Ù„Ø¨ÙˆØª Ø£Ùˆ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±ØŒ ØªØ°Ù‡Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆÙŠØ®Ø³Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø±Ù‡Ø§Ù†Ù‡
            db.ref('admin_profits/total').transaction(s => (s||0) + adminCut);
            alert("Ù‡Ø²ÙŠÙ…Ø©! Ø§Ù„Ù…Ù†Ø§ÙØ³ ÙƒØ§Ù† Ø£Ù‚ÙˆÙ‰. ğŸ’€");
        }
        db.ref('king_combat/'+activeRoomId).remove();
        location.reload();
    }

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    db.ref('king_combat').on('value', snap => {
        const rooms = snap.val();
        const listDiv = document.getElementById('available-rooms');
        listDiv.innerHTML = '<p style="font-size:12px; color:#555;">ØªØ­Ø¯ÙŠØ§Øª Ù…ÙØªÙˆØ­Ø© Ø§Ù„Ø¢Ù†:</p>';
        for(let id in rooms) {
            if(!rooms[id].p2 && rooms[id].p1 !== playerName) {
                listDiv.innerHTML += `
                    <div class="room-card">
                        <span>ğŸ‘‘ ${rooms[id].p1} <small>(${rooms[id].bet}ğŸ’°)</small></span>
                        <button onclick="joinMatch('${id}', ${rooms[id].bet})" style="background:var(--red); color:white; border:none; padding:8px 15px; border-radius:10px; cursor:pointer">Ù…Ø¨Ø§Ø±Ø²Ø©</button>
                    </div>`;
            }
        }
    });

    function joinMatch(id, bet) {
        db.ref('players_logs/'+playerName+'/score').once('value').then(s => {
            if((s.val()||0) < bet) return alert("Ø±ØµÙŠØ¯Ùƒ Ù†Ø§Ù‚Øµ!");
            db.ref('players_logs/'+playerName).update({score: s.val() - bet});
            db.ref('king_combat/'+id).update({p2: playerName, status:'active'});
            activeRoomId = id; playerRole = "p2";
            initBattleUI(bet);
        });
    }
</script>
</body>
</html>
