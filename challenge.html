<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ø¯ÙŠ Ø§Ù„Ù…ÙˆØª: Ù…Ù„Ùƒ Ø§Ù„Ø¢Ù„ÙŠÙŠÙ† âš”ï¸</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        :root { --gold: #ffcc33; --red: #ff0000; }
        body { background: #000; color: #fff; font-family: 'Cairo', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; }
        
        .setup-card { width: 95%; max-width: 450px; background: rgba(255,255,255,0.03); padding: 25px; border-radius: 30px; border: 1px solid #222; text-align: center; }
        .bet-input { width: 85%; padding: 15px; border-radius: 15px; border: 2px solid var(--gold); background: #000; color: #fff; font-size: 22px; text-align: center; margin-bottom: 25px; }

        .btn-mode { padding: 20px; border-radius: 15px; border: none; cursor: pointer; font-weight: 900; transition: 0.3s; font-size: 16px; width: 100%; margin-bottom: 10px; }
        .btn-pvp { background: var(--red); color: #fff; }
        .btn-bot { background: #333; color: var(--gold); border: 1px solid var(--gold); }

        /* Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø¹Ø±ÙƒØ© */
        .arena { height: 320px; background: url('https://i.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJndnBqZ3BqZ3BqZ3BqZ3BqZ3BqZ3BqZ3BqZ3BqZ3BqZ3BqJmVuPTEs1/3o7TKMGpxxy6T7skms/giphy.gif'); background-size: cover; position: relative; border-radius: 20px; border: 3px solid #444; margin-top: 15px; }
        .hp-bar-bg { position: absolute; top: 15px; width: 130px; height: 12px; background: #222; border-radius: 6px; border: 1px solid #555; overflow: hidden; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #f00, #ff6666); width: 100%; transition: 0.3s; }
        .left-hp { left: 10px; } .right-hp { right: 10px; }

        .char { position: absolute; bottom: 20px; width: 100px; filter: drop-shadow(0 0 15px #000); }
        .p1 { left: 10px; } .p2 { right: 10px; transform: scaleX(-1); }
        .char img { width: 100%; }

        .bullet { position: absolute; width: 30px; height: 6px; background: linear-gradient(to right, yellow, orange); border-radius: 3px; display: none; box-shadow: 0 0 15px orange; z-index: 100; }

        .fire-btn { background: linear-gradient(180deg, #ff4444, #800000); border: none; color: #fff; padding: 15px 50px; border-radius: 50px; font-weight: 900; cursor: pointer; margin-top: 20px; font-size: 22px; box-shadow: 0 5px 20px rgba(255,0,0,0.4); }
        .fire-btn:disabled { opacity: 0.4; filter: grayscale(1); }
        
        .shake { animation: shakeAnim 0.1s infinite; }
        @keyframes shakeAnim { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(0, 0); } }
    </style>
</head>
<body>

<div class="setup-card" id="lobby">
    <h2 style="color:var(--gold)">âš”ï¸ ØªØ­Ø¯ÙŠ Ù…Ù„ÙˆÙƒ Ø§Ù„Ù‚Ù†Øµ âš”ï¸</h2>
    <input type="number" id="betAmount" class="bet-input" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‡Ø§Ù† ğŸ’°">
    <button class="btn-mode btn-pvp" onclick="startMatch('player')">Ù…Ø¨Ø§Ø±Ø²Ø© Ù„Ø§Ø¹Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠ ğŸ‘¥</button>
    <button class="btn-mode btn-bot" onclick="startMatch('bot')">ØªØ­Ø¯ÙŠ Ù…Ù„Ùƒ Ø§Ù„Ø¢Ù„ÙŠÙŠÙ† (ØµØ¹Ø¨ Ø¬Ø¯Ø§Ù‹) ğŸ¤–</button>
    <div id="room-list" style="margin-top:20px"></div>
</div>

<div id="battle-screen" style="display:none; width: 95%; max-width: 450px; text-align: center;">
    <div style="color:var(--gold); font-weight:900; margin-bottom:5px;">Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©: <span id="prize-val">0</span> ğŸ’°</div>
    <div class="arena" id="arena-box">
        <div class="hp-bar-bg left-hp"><div class="hp-fill" id="hp1"></div></div>
        <div class="hp-bar-bg right-hp"><div class="hp-fill" id="hp2"></div></div>
        <div class="bullet" id="bullet-obj"></div>
        <div class="char p1"><img src="https://cdn-icons-png.flaticon.com/512/8115/8115312.png"></div>
        <div class="char p2"><img src="https://cdn-icons-png.flaticon.com/512/1070/1070807.png"></div>
    </div>
    <div id="game-info" style="margin:10px; color:#888; font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <button class="fire-btn" id="shoot-trigger" onclick="playerShoot()" disabled>ğŸ’¥ Ø¥Ø·Ù€Ù„Ø§Ù‚!</button>
</div>

<audio id="sound-gun" src="https://www.soundjay.com/mechanical/sounds/gun-shot-1-way.mp3"></audio>
<audio id="sound-hit" src="https://www.soundjay.com/free-music/sounds/explosion-01.mp3"></audio>

<script>
    const firebaseConfig = { databaseURL: "https://user-project-6c3bb-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const myName = localStorage.getItem('pName') || "Ù…Ù‚Ø§ØªÙ„";
    let myRoom = null;
    let mySide = "p1";

    function startMatch(type) {
        const bet = parseInt(document.getElementById('betAmount').value);
        if(!bet || bet < 10) return alert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø±Ù‡Ø§Ù† 10!");

        db.ref('players_logs/'+myName+'/score').once('value').then(s => {
            if((s.val()||0) < bet) return alert("Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ!");
            db.ref('players_logs/'+myName).update({score: s.val() - bet});

            const ref = db.ref('sniper_combat').push();
            myRoom = ref.key;
            const isBot = (type === 'bot');

            ref.set({
                p1: myName, p2: isBot ? "Ù…Ù„Ùƒ_Ø§Ù„Ø¢Ù„ÙŠÙŠÙ†" : null,
                bet: bet, hp1: 100, hp2: 100,
                turn: 'p1', status: isBot ? 'live' : 'wait',
                botLevel: isBot ? 'legend' : 'none'
            });
            openArena(bet);
        });
    }

    function openArena(bet) {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('battle-screen').style.display = 'block';
        document.getElementById('prize-val').innerText = (bet * 2 * 0.75);

        db.ref('sniper_combat/'+myRoom).on('value', snap => {
            const data = snap.val();
            if(!data) return;

            document.getElementById('hp1').style.width = data.hp1 + "%";
            document.getElementById('hp2').style.width = data.hp2 + "%";

            if(data.p2) {
                const turn = (data.turn === 'p1');
                document.getElementById('shoot-trigger').disabled = !turn;
                document.getElementById('game-info').innerText = turn ? "Ø¯ÙˆØ±Ùƒ.. ØµÙˆØ¨ ÙˆØ£Ø·Ù„Ù‚!" : "Ø§Ù„Ø®ØµÙ… ÙŠØµÙˆØ¨ Ø¹Ù„ÙŠÙƒ.. Ø§Ø­Ø°Ø±!";
                
                if(data.botLevel === 'legend' && data.turn === 'p2' && data.hp2 > 0) {
                    setTimeout(botSniperAction, 1200);
                }
            }

            if(data.lastShot && data.lastShot.by !== 'p1') {
                animateShot('p2', data.lastShot.hit);
                db.ref('sniper_combat/'+myRoom+'/lastShot').remove();
            }

            if(data.hp1 <= 0 || data.hp2 <= 0) endGame(data);
        });
    }

    function playerShoot() {
        document.getElementById('shoot-trigger').disabled = true;
        const hit = Math.random() > 0.3; // Ø¥ØµØ§Ø¨Ø© 70%
        const damage = hit ? (Math.floor(Math.random()*15)+15) : 0;
        
        db.ref('sniper_combat/'+myRoom).once('value').then(snap => {
            animateShot('p1', hit);
            setTimeout(() => {
                db.ref('sniper_combat/'+myRoom).update({
                    hp2: Math.max(0, snap.val().hp2 - damage),
                    turn: 'p2', lastShot: { by: 'p1', hit: hit }
                });
            }, 500);
        });
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹
    function botSniperAction() {
        const hit = Math.random() > 0.25; // Ø§Ù„Ø¨ÙˆØª ÙŠØµÙŠØ¨ Ø¨Ù†Ø³Ø¨Ø© 75% (Ù‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹)
        const damage = hit ? (Math.floor(Math.random()*20)+15) : 0;
        
        db.ref('sniper_combat/'+myRoom).once('value').then(snap => {
            if(!snap.val() || snap.val().turn !== 'p2') return;
            animateShot('p2', hit);
            setTimeout(() => {
                db.ref('sniper_combat/'+myRoom).update({
                    hp1: Math.max(0, snap.val().hp1 - damage),
                    turn: 'p1', lastShot: { by: 'p2', hit: hit }
                });
            }, 500);
        });
    }

    function animateShot(side, hit) {
        const b = document.getElementById('bullet-obj');
        const sndGun = document.getElementById('sound-gun');
        const sndHit = document.getElementById('sound-hit');
        const arena = document.getElementById('arena-box');

        sndGun.currentTime = 0; sndGun.play();
        b.style.display = "block";
        
        if(side === 'p1') {
            b.style.left = "80px";
            b.animate([{left:'80px'}, {left:'360px'}], {duration: 400, fill: 'forwards'});
        } else {
            b.style.left = "360px";
            b.animate([{left:'360px'}, {left:'80px'}], {duration: 400, fill: 'forwards'});
        }

        setTimeout(() => {
            b.style.display = "none";
            if(hit) {
                sndHit.currentTime = 0; sndHit.play();
                arena.classList.add('shake');
                setTimeout(() => arena.classList.remove('shake'), 200);
            }
        }, 400);
    }

    function endGame(data) {
        const win = data.hp1 <= 0 ? data.p2 : data.p1;
        if(win === myName) {
            confetti({particleCount: 200, spread: 70});
            db.ref('players_logs/'+myName+'/score').transaction(s => (s||0) + (data.bet * 2 * 0.75));
            db.ref('admin_profits/total').transaction(s => (s||0) + (data.bet * 2 * 0.25));
            alert("ğŸ”¥ Ù†ØµØ± Ù…Ù„ÙƒÙŠ Ø³Ø§Ø­Ù‚! Ø±Ø¨Ø­Øª Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©.");
        } else {
            alert("ğŸ’€ Ø³Ø­Ù‚ØªÙƒ Ù†ÙŠØ±Ø§Ù† Ø§Ù„Ù…Ù†Ø§ÙØ³.. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");
        }
        db.ref('sniper_combat/'+myRoom).remove();
        location.reload();
    }

    // Ø¹Ø±Ø¶ Ø§Ù„ØºØ±Ù
    db.ref('sniper_combat').on('value', snap => {
        const rooms = snap.val();
        const div = document.getElementById('room-list');
        div.innerHTML = "<h4 style='color:#555'>ØªØ­Ø¯ÙŠØ§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø±Ùƒ:</h4>";
        for(let id in rooms) {
            if(!rooms[id].p2 && rooms[id].p1 !== myName) {
                div.innerHTML += `<div style="background:#111; padding:10px; border-radius:10px; margin-bottom:10px; border:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ‘‘ ${rooms[id].p1} (${rooms[id].bet}ğŸ’°)</span>
                    <button onclick="join('${id}', ${rooms[id].bet})" style="background:var(--red); color:#fff; border:none; padding:5px 15px; border-radius:8px; cursor:pointer">Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªØ­Ø¯ÙŠ</button>
                </div>`;
            }
        }
    });

    function join(id, bet) {
        db.ref('players_logs/'+myName+'/score').once('value').then(s => {
            if((s.val()||0) < bet) return alert("Ø±ØµÙŠØ¯Ùƒ Ù†Ø§Ù‚Øµ!");
            db.ref('players_logs/'+myName).update({score: s.val() - bet});
            db.ref('sniper_combat/'+id).update({p2: myName, status:'live'});
            myRoom = id; mySide = "p2";
            openArena(bet);
        });
    }
</script>
</body>
</html>
