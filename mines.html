<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†Ø¬Ù… Ø¨Ù„Ø§ØªÙŠÙ†ÙŠÙˆÙ… â›ï¸</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        :root { --gold: #ffcc33; --neon: #00ff44; --red: #ff4444; }
        body { background: #000; color: #fff; font-family: 'Cairo', sans-serif; text-align: center; margin: 0; padding: 20px; }
        
        .game-wrapper { max-width: 400px; margin: auto; }
        .stats-panel { background: #111; padding: 15px; border-radius: 15px; border: 1px solid #222; margin-bottom: 15px; }
        .balance-val { color: var(--gold); font-weight: 900; font-size: 20px; }
        
        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ù„Ø¹Ø¨ */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 20px 0; }
        .cell { aspect-ratio: 1; background: #1a1a1a; border: 1px solid #333; border-radius: 10px; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .cell.open { background: #222; border-color: var(--gold); cursor: default; }
        .cell.bomb { background: var(--red) !important; border-color: #fff; }
        
        /* Ø§Ù„ØªØ­ÙƒÙ… */
        input { background: #000; color: #fff; border: 1px solid #444; padding: 12px; width: 80%; border-radius: 10px; text-align: center; font-size: 16px; margin-bottom: 10px; }
        .btn { border: none; padding: 15px 30px; border-radius: 10px; font-weight: 900; width: 85%; cursor: pointer; transition: 0.3s; font-family: 'Cairo'; }
        .btn-start { background: var(--gold); color: #000; }
        .btn-cash { background: var(--neon); color: #000; display: none; }
        
        .multi-display { font-size: 24px; color: var(--neon); font-weight: 900; margin: 10px 0; }
    </style>
</head>
<body>

<div class="game-wrapper">
    <div class="stats-panel">
        <div style="font-size: 12px; color: #888;">Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨</div>
        <div class="balance-val" id="balanceText">0</div>
    </div>

    <input type="number" id="betInput" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‡Ø§Ù†">
    <button class="btn btn-start" id="startBtn" onclick="startGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø© â›ï¸</button>
    <button class="btn btn-cash" id="cashBtn" onclick="cashOut()">Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (X<span id="multi">1.00</span>)</button>

    <div class="multi-display" id="multiBox" style="visibility: hidden;">Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: X<span id="multiVal">1.00</span></div>
    
    <div class="grid" id="mineGrid"></div>
    
    <a href="index.html" style="color: #555; text-decoration: none; font-size: 13px;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://user-project-6c3bb-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const pName = localStorage.getItem('pName');

    let score = 0;
    let bet = 0;
    let bombs = [];
    let openedCount = 0;
    let isGaming = false;
    let canCashOut = false;

    // Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­ÙŠ
    db.ref('players_logs/' + pName).on('value', (s) => {
        score = s.val() ? s.val().score : 0;
        document.getElementById('balanceText').innerText = score.toLocaleString();
    });

    function createGrid() {
        const grid = document.getElementById('mineGrid');
        grid.innerHTML = '';
        for (let i = 0; i < 25; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.onclick = () => revealCell(i, cell);
            grid.appendChild(cell);
        }
    }

    function startGame() {
        bet = Math.floor(document.getElementById('betInput').value);
        if (isNaN(bet) || bet <= 0 || bet > score) return alert("âŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ Ø£Ùˆ Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­");

        // Ø®ØµÙ… Ø§Ù„Ø±Ù‡Ø§Ù† ÙÙˆØ±Ø§Ù‹
        db.ref('players_logs/' + pName).update({ score: score - bet }).then(() => {
            isGaming = true;
            canCashOut = true;
            openedCount = 0;
            bombs = [];
            
            // ØªÙˆØ²ÙŠØ¹ 3 Ù‚Ù†Ø§Ø¨Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
            while(bombs.length < 3) {
                let r = Math.floor(Math.random() * 25);
                if(!bombs.includes(r)) bombs.push(r);
            }

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('cashBtn').style.display = 'block';
            document.getElementById('multiBox').style.visibility = 'visible';
            document.getElementById('multiVal').innerText = "1.00";
            document.getElementById('multi').innerText = "1.00";
            createGrid();
        });
    }

    function revealCell(index, element) {
        if (!isGaming || element.classList.contains('open')) return;

        if (bombs.includes(index)) {
            element.classList.add('open', 'bomb');
            element.innerText = 'ğŸ’£';
            showAllBombs();
            endGame(false);
        } else {
            element.classList.add('open');
            element.innerText = 'ğŸ’';
            openedCount++;
            let currentMulti = (1 + (openedCount * 0.25)).toFixed(2);
            document.getElementById('multiVal').innerText = currentMulti;
            document.getElementById('multi').innerText = currentMulti;
        }
    }

    function showAllBombs() {
        const cells = document.getElementsByClassName('cell');
        bombs.forEach(bIndex => {
            cells[bIndex].classList.add('open', 'bomb');
            cells[bIndex].innerText = 'ğŸ’£';
        });
    }

    function cashOut() {
        if (!isGaming || !canCashOut || openedCount === 0) return;

        canCashOut = false; 
        let multi = parseFloat(document.getElementById('multi').innerText);
        let winAmt = Math.floor(bet * multi);

        db.ref('players_logs/' + pName).update({ score: score + winAmt })
        .then(() => {
            alert(`ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ø¨Ø­Øª ${winAmt} Ù„ÙŠØ±Ø©`);
            resetUI();
        })
        .catch(() => { canCashOut = true; });
    }

    function endGame(win) {
        isGaming = false;
        canCashOut = false;
        if (!win) {
            setTimeout(() => {
                alert("ğŸ’¥ Ø¨ÙˆÙ…! Ù„Ù‚Ø¯ Ø®Ø³Ø±Øª Ø§Ù„Ø±Ù‡Ø§Ù†.");
                resetUI();
            }, 800);
        }
    }

    function resetUI() {
        isGaming = false;
        canCashOut = false;
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('cashBtn').style.display = 'none';
        document.getElementById('multiBox').style.visibility = 'hidden';
    }

    createGrid();
</script>
</body>
</html>
