<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯ÙˆØ§Ø± Ø§Ù„Ø­Ø¸ - Ù†Ø³Ø®Ø© Ø§Ù„ØªÙˆØ§Ø²Ù† Ø§Ù„Ø°ÙƒÙŠ ğŸ°</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap');
        body { background: radial-gradient(circle, #1a0f00 0%, #000 100%); color: #d4af37; font-family: 'Cairo', sans-serif; text-align: center; margin: 0; overflow: hidden; }
        .header { background: #000; border-bottom: 2px solid #d4af37; padding: 10px; display: flex; justify-content: space-around; align-items: center; }
        .bal-display { background: #111; border: 1px solid #d4af37; padding: 5px 15px; border-radius: 8px; color: #ffd700; font-size: 18px; }
        .wheel-box { position: relative; width: 320px; height: 320px; margin: 30px auto; border: 12px solid #8a6d3b; border-radius: 50%; background: #1a1a1a; box-shadow: 0 0 50px #000; }
        #canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 7.5s cubic-bezier(0.1, 0, 0.1, 1); }
        .pointer { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); width: 45px; height: 55px; z-index: 100; }
        .pointer::after { content: ''; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 35px solid #ffd700; position: absolute; }
        .controls { position: fixed; bottom: 0; width: 100%; background: #000; padding: 15px 0; border-top: 3px solid #d4af37; border-radius: 25px 25px 0 0; }
        .chips { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .chip { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #d4af37; display: flex; justify-content: center; align-items: center; cursor: pointer; background: #000; font-size: 13px; font-weight: bold; }
        .chip.active { background: #d4af37; color: #000; transform: scale(1.1); box-shadow: 0 0 10px #d4af37; }
        .btn-spin { background: linear-gradient(180deg, #ffd700, #8a6d3b); color: #000; border: none; padding: 12px 60px; border-radius: 10px; font-size: 22px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <audio id="s_spin" src="https://assets.mixkit.co/active_storage/sfx/2005/2005-preview.mp3"></audio>
    <audio id="s_win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>
    <audio id="s_lose" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

    <div class="header">
        <div>ğŸ‘¤ <span id="uName">--</span></div>
        <div class="bal-display">ğŸ’° <span id="uBal">0</span></div>
    </div>

    <div class="wheel-box">
        <div class="pointer"></div>
        <canvas id="canvas" width="600" height="600"></canvas>
    </div>

    <div class="controls">
        <div class="chips">
            <div class="chip active" id="c100" onclick="setBet(100)">100</div>
            <div class="chip" id="c500" onclick="setBet(500)">500</div>
            <div class="chip" id="c1000" onclick="setBet(1000)">1000</div>
            <div class="chip" id="c5000" onclick="setBet(5000)">5000</div>
            <div class="chip" id="c10000" onclick="setBet(10000)">10000</div>
        </div>
        <button class="btn-spin" id="spinBtn" onclick="runGame()">Ø¥Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù†</button>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://user-project-6c3bb-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = localStorage.getItem('game_user') || prompt("Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨:");
    localStorage.setItem('game_user', user || "Ù„Ø§Ø¹Ø¨");

    let bal = 0, bet = 100, currentRot = 0;
    let lastResultWasLoss = 0; // Ø¹Ø¯Ø§Ø¯ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©

    const items = ["200", "1000", "500", "2000", "5000", "10000", "Ø­Ø¸ Ø£ÙˆÙØ±"];
    const colors = ["#1a1a1a", "#d4af37", "#1a1a1a", "#d4af37", "#1a1a1a", "#d4af37", "#7e0000"];

    function setBet(v) {
        bet = v;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        document.getElementById('c'+v).classList.add('active');
    }

    function draw() {
        const x = document.getElementById('canvas').getContext('2d');
        const arc = (Math.PI * 2) / items.length;
        x.clearRect(0,0,600,600);
        for(let i=0; i<items.length; i++) {
            x.save(); x.beginPath(); x.fillStyle = colors[i]; x.moveTo(300,300);
            let s = i * arc - (Math.PI/2) - (arc/2);
            let e = (i+1) * arc - (Math.PI/2) - (arc/2);
            x.arc(300,300,300, s, e); x.fill();
            x.strokeStyle = "#d4af37"; x.lineWidth = 4; x.stroke();
            x.translate(300,300); x.rotate(i*arc - Math.PI/2);
            x.fillStyle = colors[i]==="#d4af37"?"#000":"#ffd700";
            x.font="bold 34px Cairo"; x.textAlign="right"; x.fillText(items[i], 250, 12);
            x.restore();
        }
        x.beginPath(); x.arc(300,300,35,0,Math.PI*2); x.fillStyle="#d4af37"; x.fill();
    }

    function init() {
        document.getElementById('uName').innerText = user;
        db.ref('players_logs/'+user).on('value', s => {
            let d = s.val();
            if(d) { bal = Number(d.score); document.getElementById('uBal').innerText = bal.toLocaleString(); }
            else { db.ref('players_logs/'+user).set({username:user, score:0, spins:0}); }
        });
        draw();
    }

    function runGame() {
        if(bal < bet) return alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ!");
        const userRef = db.ref('players_logs/'+user);
        
        userRef.transaction(c => {
            if(c && c.score >= bet) { 
                c.score -= bet; 
                c.spins = (c.spins || 0) + 1; 
                return c; 
            }
        }, (err, comm, snap) => {
            if(comm) {
                const data = snap.val();
                const sNum = data.spins;
                const balAfterBet = data.score;
                document.getElementById('spinBtn').disabled = true;
                document.getElementById('s_spin').play();

                let target;
                // Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ (Ø£ÙˆÙ„ 3 Ø¶Ø±Ø¨Ø§Øª)
                if(sNum === 1) target = 5;      // Ø±Ø¨Ø­ 10000
                else if(sNum === 2) target = 5; // Ø±Ø¨Ø­ 10000
                else if(sNum === 3) target = 6; // Ø®Ø³Ø§Ø±Ø©
                else {
                    // Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª 45% Ø±Ø¨Ø­ + Ù…Ù†Ø¹ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ© (>2)
                    if (lastResultWasLoss >= 2) {
                        // Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø±Ø¨Ø­ Ø¥Ø°Ø§ Ø®Ø³Ø± Ù…Ø±ØªÙŠÙ† ÙˆØ±Ø§ Ø¨Ø¹Ø¶
                        target = Math.floor(Math.random() * 5); 
                    } else {
                        let luck = Math.random() * 100;
                        if(luck < 55) target = 6; // 55% Ø®Ø³Ø§Ø±Ø©
                        else target = Math.floor(Math.random() * 5); // 45% Ø±Ø¨Ø­
                    }
                }

                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©
                if(target === 6) lastResultWasLoss++;
                else lastResultWasLoss = 0;

                const deg = 360 / items.length;
                const targetRot = (360 - (target * deg));
                currentRot += 3600 + (targetRot - (currentRot % 360));
                document.getElementById('canvas').style.transform = `rotate(${currentRot}deg)`;

                setTimeout(() => {
                    let val = items[target];
                    if(val === "Ø­Ø¸ Ø£ÙˆÙØ±") {
                        document.getElementById('s_lose').play();
                        alert("Ù‡Ø§Ø±Ø¯Ù„Ùƒ! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                    } else {
                        document.getElementById('s_win').play();
                        let prize = parseInt(val);
                        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ù‡Ø§Ù† + Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©
                        userRef.update({score: balAfterBet + bet + prize});
                        alert("Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ø¨Ø­Øª " + prize + " Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ø¥Ø³ØªØ±Ø¯Ø§Ø¯ Ø±Ù‡Ø§Ù†Ùƒ.");
                        confetti({particleCount:150, spread: 70});
                    }
                    document.getElementById('spinBtn').disabled = false;
                }, 7500);
            }
        });
    }
    init();
</script>
</body>
</html>
